<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <link rel="stylesheet" href="cms.css" />

    <!-- ğŸ‘‡ Delay CMS auto init -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>

  <body>
    <div class="logo-container">
      <img src="./prosper-website-logo.png" alt="Prosper XO" class="logo" />
    </div>

    <!-- ğŸ‘‡ Load Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- ğŸ‘‡ Load Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.1.2/dist/decap-cms.js"></script>

    <!-- ğŸ‘‡ Netlify Identity Callback Handling -->
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", (user) => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/";
            });
          }
        });
        window.netlifyIdentity.on("close", () => {
          window.netlifyIdentity.close();
        });
      }
    </script>

    <!-- ğŸ‘‡ Enhanced Debugging Script -->
    <script>
      // Debug Netlify Identity
      console.log("ğŸ” Starting Netlify Identity Debug...");

      // Check if Netlify Identity is loaded
      if (window.netlifyIdentity) {
        console.log("âœ… Netlify Identity loaded successfully");

        // Debug authentication state
        window.netlifyIdentity.on("init", (user) => {
          console.log("ğŸ” Identity initialized, user:", user);
          if (user) {
            console.log("ğŸ‘¤ User is authenticated:", user.email);
            console.log("ğŸ”‘ User token:", user.token);
            console.log("ğŸ†” User ID:", user.id);
            console.log("ğŸ“§ User email confirmed:", user.email_confirmed_at);
          } else {
            console.log("âŒ No user authenticated");
          }
        });

        // Debug login events
        window.netlifyIdentity.on("login", (user) => {
          console.log("ğŸ‰ Login successful:", user.email);
          console.log("ğŸ”‘ New token:", user.token);
        });

        // Debug logout events
        window.netlifyIdentity.on("logout", () => {
          console.log("ğŸ‘‹ User logged out");
          // Clear all authentication data
          localStorage.removeItem("netlify-identity-token");
          localStorage.removeItem("netlify-identity-user");
          localStorage.removeItem("gotrue.user");
          localStorage.removeItem("gotrue.session");
          sessionStorage.clear();
          console.log("ğŸ§¹ Cleared all authentication data");

          // Force refresh the identity widget
          setTimeout(() => {
            if (window.netlifyIdentity) {
              window.netlifyIdentity.close();
              console.log("ğŸ”„ Refreshed identity widget");
            }
          }, 100);
        });

        // Debug errors
        window.netlifyIdentity.on("error", (err) => {
          console.error("âŒ Identity error:", err);

                    // Handle token errors by clearing stale data
          if (err.message && err.message.includes("invalid_grant")) {
            console.log("ğŸ”„ Clearing stale tokens due to invalid_grant error");
            localStorage.removeItem("netlify-identity-token");
            localStorage.removeItem("netlify-identity-user");
            localStorage.removeItem("gotrue.user");
            localStorage.removeItem("gotrue.session");
            sessionStorage.clear();
            console.log("ğŸ§¹ Cleared all auth data. Try logging in again or run resetAuth() for manual reset");
          }
        });

        // Debug close events
        window.netlifyIdentity.on("close", () => {
          console.log("ğŸšª Identity widget closed");
        });
      } else {
        console.error("âŒ Netlify Identity not loaded");
      }

              // Debug CMS initialization
        console.log("ğŸ“ Initializing CMS...");
        
        // Add manual reset function for debugging
        window.resetAuth = function() {
          console.log("ğŸ”„ Manual auth reset triggered");
          localStorage.removeItem("netlify-identity-token");
          localStorage.removeItem("netlify-identity-user");
          localStorage.removeItem("gotrue.user");
          localStorage.removeItem("gotrue.session");
          sessionStorage.clear();
          window.location.reload();
        };
        
        console.log("ğŸ› ï¸ Manual reset available: run resetAuth() in console if needed");
    </script>

    <!-- ğŸ‘‡ Manually init CMS -->
    <script>
      CMS.init();
    </script>
  </body>
</html>
