<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <link rel="stylesheet" href="cms.css" />

    <!-- ğŸ‘‡ Delay CMS auto init -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>

  <body>
    <div class="logo-container">
      <img src="./prosper-website-logo.png" alt="Prosper XO" class="logo" />
    </div>

    <!-- ğŸ‘‡ Load Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- ğŸ‘‡ Load Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.1.2/dist/decap-cms.js"></script>

    <!-- ğŸ‘‡ Netlify Identity Callback Handling -->
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", (user) => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/cms/";
            });
          }
        });
        window.netlifyIdentity.on("close", () => {
          window.netlifyIdentity.close();
        });
      }
    </script>

    <!-- ğŸ‘‡ Enhanced Debugging Script -->
    <script>
      // Debug Netlify Identity
      console.log("ğŸ” Starting Netlify Identity Debug...");

      // Check if Netlify Identity is loaded
      if (window.netlifyIdentity) {
        console.log("âœ… Netlify Identity loaded successfully");

        // Debug authentication state
        window.netlifyIdentity.on("init", (user) => {
          console.log("ğŸ” Identity initialized, user:", user);
          if (user) {
            console.log("ğŸ‘¤ User is authenticated:", user.email);
            console.log("ğŸ”‘ User token:", user.token);
          } else {
            console.log("âŒ No user authenticated");
          }
        });

        // Debug login events
        window.netlifyIdentity.on("login", (user) => {
          console.log("ğŸ‰ Login successful:", user.email);
          console.log("ğŸ”‘ New token:", user.token);
        });

        // Debug logout events
        window.netlifyIdentity.on("logout", () => {
          console.log("ğŸ‘‹ User logged out");
        });

        // Debug errors
        window.netlifyIdentity.on("error", (err) => {
          console.error("âŒ Identity error:", err);
        });

        // Debug close events
        window.netlifyIdentity.on("close", () => {
          console.log("ğŸšª Identity widget closed");
        });
      } else {
        console.error("âŒ Netlify Identity not loaded");
      }

      // Debug CMS initialization
      console.log("ğŸ“ Initializing CMS...");
    </script>

    <!-- ğŸ‘‡ Manually init CMS -->
    <script>
      CMS.init();
    </script>
  </body>
</html>
